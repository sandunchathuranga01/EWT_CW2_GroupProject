<html>
<head>
    <!-- Include jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load("current", {
            "packages": ["map"],
            "mapsApiKey": "AIzaSyBSoQrR3G-RybhYs3rwFMaDvJbPs-dgod4"
        });

        google.charts.setOnLoadCallback(getDisposalPlaces);

        function getDisposalPlaces() {

            // Function to get the user's current location
            function getUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showUserLocation);
                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            }

            // Function to show user's location on the map
            function showUserLocation(position) {
                // Add the user's location to the mapData array
                mapData.push([position.coords.latitude, position.coords.longitude, "Your Location"]);

                // Convert the updated data array to Google DataTable
                var dataTable = google.visualization.arrayToDataTable([
                    ['Lat', 'Long', 'Address'],
                    ...mapData
                ]);

                // Create map and draw it
                var map = new google.visualization.Map(document.getElementById('map_div'));
                map.draw(dataTable, {
                    showTooltip: true,
                    showInfoWindow: true
                });
            }

            // Function to handle "Direction" button click and fill direction fields
            function connectToGoogleMaps(lat, lng, address) {
                // Assume you have direction fields with IDs 'startPoint' and 'endPoint'
                var startPoint = document.getElementById('startPoint');
                var endPoint = document.getElementById('endPoint');

                // Get the user's current location
                navigator.geolocation.getCurrentPosition(function (position) {
                    // Fill direction fields with user's location and clicked disposal place's location
                    startPoint.value = position.coords.latitude + ',' + position.coords.longitude; // User's location
                    endPoint.value = lat + ',' + lng; // Clicked disposal place's location

                    // Open a new window/tab with Google Maps directions
                    window.open('https://www.google.com/maps/dir/' + startPoint.value + '/' + endPoint.value);
                }, function (error) {
                    console.error("Error getting user's location:", error);
                });
            }

            // Array to store disposal places and user's location
            let mapData = [];

            // Get disposal places
            $.ajax({
                method: "get",
                url: "http://localhost:8080/api/v1/disposal_place/getAllDisposalPlaces",
                async: true,
                success: function (data) {
                    if (data.code === "00") {
                        // Add disposal places to the mapData array
                        mapData = data.content.map(disposal => [disposal.lat, disposal.lng, disposal.address]);

                        // Get the user's current location
                        getUserLocation();

                        // Create a single "Direction" button
                        var directionButton = document.createElement('button');
                        directionButton.textContent = 'Get Directions';
                        directionButton.addEventListener('click', function () {
                            // Use the first disposal place as the endpoint
                            connectToGoogleMaps(mapData[1][0], mapData[1][1], mapData[1][2]);
                        });
                        document.body.appendChild(directionButton);
                    }
                }
            });
        }
    </script>
</head>

<body>
<h1>hello</h1>
<div id="map_div" style="width: 800px; height: 700px"></div>
<!-- Direction fields for Google Maps -->
<input type="text" id="startPoint" style="display:none;">
<input type="text" id="endPoint" style="display:none;">
</body>
</html>
